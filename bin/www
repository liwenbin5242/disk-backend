const http = require('http');
const rediser = require('../utils/rediser');
const mongodber = require('../utils/mongodber');
const PG = require('../utils/pg');
const config = require('config');
const {logger} = require('../utils/logger');
const axios = require('axios');
const {machineId, machineIdSync} = require('node-machine-id');
async function initDb() {
    let databases = config.get('MONGODBS');
    await mongodber.init(databases);
    logger.info('mongo is ready!');
}
async function initRedis() {
    const redisConfig = config.get('REDIS');
    await new Promise((resolve) => {
        rediser.init(redisConfig, function (err) {
            if (err) {
                logger.error('Connect Redis Error: ' + err);
            } else {
                logger.info('Redis is ready!');
                return resolve();
            }
        });
    });
}
async function initMachid() {
    let machid = await machineId();
    const data = await axios.post(`${config.get('AuthServer')}/api/agent/register`, {machid})
    if(data.data.code === 0) {
        global.machid = machid;
    }
}

async function auth() {
    setInterval(async() => {
        try {
            const data = await axios.get(`${config.get('AuthServer')}/api/agent/verify?machid=${global.machid}`)
            if(data.data.code === 0 && data.data.data.auth ) {
                global.auth = {auth: data.data.data.auth, expires: data.data.data.expires}
            } else {
                global.auth = {
                    auth: false,
                    message: '未授权'
                }
            };
        } catch (error) {
            logger.error(error)
        }
    }, 1000 * 60)
}
(async function init() {
    await initDb();
    await initRedis();
    await initMachid()
    await auth()
    const app = require('../app');
    const port = config.get('app.port');
    app.set('port', port);
    const server = http.createServer(app);
    server.listen(port);
    server.on('error', onError);

    logger.info('Listening on ' + port);
})();
function onError(error) {
    if (error.syscall !== 'listen') {
        throw error;
    }
    const bind = config.get('app.port');
    switch (error.code) {
    case 'EACCES':
        logger.error(bind + ' 权限不足,请使用root权限运行');
        process.exit(1);
    case 'EADDRINUSE':
        logger.error(bind + ' 已被占用');
        process.exit(1);
    default:
        throw error;
    }
}
process.on('uncaughtException', function (err) {
    logger.error('Caught exception: ' + err.stack);
});